#! /bin/bash

export MANDIR=../man

# inla.models.generate call has been moved to the Makefile, to allow
# overriding the R binary
# But Rsort also needs it, so caller must specify it
RR=$1
echo ${RR}

function mmp ()
{
    awk '/:EXTRA:/ {$1=""; $2="";extra = $0; next}
   /:NAME:/{
	name=$3
	f=  MANDIR "/" name ".Rd"
	print "Make help page", f >> "/dev/stderr"
	print f >> "/dev/stdout"
        print "%%" > f
        print "%% WARNING! DO NOT EDIT!" >> f
        print "%% This file is automatically generated from " filename  >> f
        print "%%" >> f
	print "\\name{" $3 "}" >> f
	print "\\alias{" $3 "}" >> f
	print "\\alias{inla." $3 "}" >> f
	print "\\alias{inla.set." $3 ".default}" >> f
	print "\\alias{set." $3 ".default}" >> f
	print "\\alias{"$3 ".default}" >> f
	print "\\title{Control variables in " name "}" >> f
	print "\\description{Control variables in \\code{" name "} for use in \\code{inla}}" >>f
	print "\\usage{" >> f
	##print "inla(formula, ..., " name "=list( <arg>=<value>[, <arg>=<value>]))" >>f
        print "inla.set." name ".default(...)" >> f
        print name "(REPLACEME)" >> f
	print "}" >> f
	print "\\arguments{" >> f
	print "\\item{...}{Possible arguments}" >> f
	next;}
    /:ARGUMENT:/{ arg=$3; $2=""; $1="";$3=""; 
	while(gsub(/##/, " "));
	print "\\item{" arg "}{" $0 "}" >> f
	next;}
    /:ARGUMENT[+]:/{ arg=$3; $2=""; $1="";$3=""; 
	while(gsub(/##/, " "));
	a= "\\item{" arg "}{" $0 
	ok=1
	while(1) {
		 getline
		 if (0) print "get new line " >> "/dev/stderr"
		 if (0) print $0 >> "/dev/stderr"
		 if ($0 ~ /:ARGUMENT[+]:/) {
		 	while(gsub(/##/, " "));
			$1=""
			a = a " " $0
		 } else {
		   break
		 }		   
        }		 
	if (0) print "END " >> "/dev/stderr"
	print a "}\n" >> f
	next;}
    /:SEEALSO:/ {
	print "}" >> f
	print "\\value{" >> f
        print " " extra >> f
        print "The function \\code{" name "} is used to TAB-complete arguments and returns a list of given arguments." >> f
        print "The function \\code{inla.set." name ".default} returns a list with all the default values of all parameters within this control statement." >> f
        print "}" >> f
        extra = ""
	print "\\seealso{" >> f
	print SEEALSO >> f
	for(i=3;i<=NF-1;i++){
	    print "\\code{\\link{" $i "}}," >> f
	}
	if (NF>2){
	    print "\\code{\\link{" $NF "}}" >> f
	}
        print "}" >> f
	next;
    }' MANDIR=$MANDIR SEEALSO="$SEEALSO" filename="$1"
}	    

SEEALSO=$(grep :NAME: set.default.arguments.R|awk '{printf "\\\\code{\\\\link{%s}}, ",  $3}')
for f in set.default.arguments.R; do
    helppages=$(awk '$0 ~ /:[A-Z+]+:/ || NF==0{print}' $f | mmp $f)
done

Rsort () {
    ## sort using R (to get the same ordering)
    export TT_FILE=$(echo ~/tmp/tt)
    export TTT_FILE=$(echo ~/tmp/ttt)

    rm -f $TT_FILE $TTT_FILE
    cat > $TT_FILE
    echo 'write(sort(readLines(Sys.getenv("TT_FILE"))),ncol=1,file=Sys.getenv("TTT_FILE"))' | ${RR} --vanilla --slave 2>/dev/null
    cat $TTT_FILE
}

for f in $helppages; do
    ## need to replace REPLACEME with a sorted list of all arguments
    echo "Postprocess $f"
    WITHTHIS=$(grep '\\item' $f | awk '$0 !~ /[.][.][.]/{print}' | awk -F'}' '{print $1}' | awk -F'{' 'NF > 1{print $2}'|Rsort|awk 'NR==1{a=$1;next;}{printf a ", "; a=$1;};END{printf a}')
    echo "f=[$f] WITHTHIS=[$WITHTHIS]"
    awk '/REPLACEME/{gsub(/REPLACEME/,WITHTHIS);print;next};{print}' WITHTHIS="$WITHTHIS" $f > tt && mv -f tt $f
done

## second part
for f in *.R; do
    if grep -E -q '^[ \t]*## ?!' $f; then
	
	fname=${f%%.R}.Rd
	{
	    echo "%%" 
	    echo "%% WARNING! DO NOT EDIT!" 
	    echo "%% This file is automatically generated from $f" 
	    echo "%%" 
	    awk '/^[ \t]*## ?!/ { gsub(/^[ \t]*## ?!/, ""); print }' $f  
	} > ../man/$fname
	echo "Make help page from $f"
	
    fi
done

## NAMESPACE generation has been moved to Makefile
